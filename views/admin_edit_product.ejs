<!-- views/admin_edit_product.ejs -->

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Редактировать товар - Админ-панель</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/admin.css"> <!-- Убедитесь, что этот файл существует -->
</head>
<body>
    <header>
        <nav>
            <div class="logo">
                <!-- Логотип -->
                <a href="/index.html">
                    <p>LED SYSTEM PRODUCTION</p>
                </a>
            </div>
            <div class="nav-links">
                <a href="/index.html">КОМПАНИЯ</a>
                <a href="/catalog.html">ТОВАРЫ</a>
                <a href="/requisites.html">КОНТАКТЫ</a>
                <a href="/admin">АДМИН-ПАНЕЛЬ</a>
                <a href="/admin/logout">ВЫЙТИ</a>
            </div>
            <div class="telephone header-telephone">
                <div class="telephone-numbers">
                    <p class="primary-number">+7 705 371 02 50</p>
                    <p class="secondary-number">+7 705 444 77 03</p>
                </div>
                <span class="arrow">&#9660;</span> <!-- Стрелка вниз -->
            </div>
        </nav>
    </header>
    <main>
        <div class="edit-product-container">

            <!-- Всплывающие уведомления -->
            <% if (success_msg && success_msg.length > 0) { %>
                <div class="toast success">
                    <%= success_msg %>
                </div>
            <% } %>

            <% if (error_msg && error_msg.length > 0) { %>
                <div class="toast error">
                    <%= error_msg %>
                </div>
            <% } %>

            <h1>Редактировать товар</h1>

            <% if (errors && errors.length > 0) { %>
                <ul class="errors">
                    <% errors.forEach(error => { %>
                        <li><%= error.msg %></li>
                    <% }) %>
                </ul>
            <% } %>

            <form id="editProductForm" action="/admin/products/edit/<%= product.id %>" method="POST" enctype="multipart/form-data">
                <!-- Добавляем CSRF-токен -->
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">

                <!-- Скрытое поле для передачи текущего изображения -->
                <input type="hidden" name="current_image" value="<%= product.image %>">
                
                <label for="image">Изображение:</label>
                <input type="file" id="image" name="image" accept="image/*"><br>
                <p>Текущее изображение:</p>
                <img src="/uploads/<%= product.image %>" alt="<%= product.name %>" class="current-image"><br>

                <label for="name">Название:</label>
                <input type="text" id="name" name="name" value="<%= product.name %>" required><br>

                <label for="price">Цена (₸):</label>
                <% 
                    // Форматирование цены для поля ввода
                    let price = parseFloat(product.price);
                    let displayPrice = price.toLocaleString('ru-RU', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
                %>
                <input type="text" id="price" name="price" value="<%= displayPrice %>" required><br>

                <label for="description">Описание:</label>
                <textarea id="description" name="description" required><%= product.description %></textarea><br>

                <label for="characteristics">Характеристики:</label>
                <textarea id="characteristics" name="characteristics" required><%= product.characteristics %></textarea><br>

                <button type="submit" id="add-product">Сохранить изменения</button>
            </form>
        </div>
    </main>
    <footer>
        <p id="license">&copy; 2024 ТОО «LED SYSTEM PRODUCTION»</p>
        <div class="nav-links">
            <a href="/index.html">КОМПАНИЯ</a>
            <a href="/catalog.html">ТОВАРЫ</a>
            <a href="/requisites.html">КОНТАКТЫ</a>
        </div>
        <div class="telephone footer-telephone">
            <div class="telephone-numbers">
                <p class="primary-number">+7 705 371 02 50</p>
                <p class="secondary-number">+7 705 444 77 03</p>
            </div>
            <span class="arrow">&#9650;</span> <!-- Стрелка вверх -->
        </div>
    </footer>

    <!-- Всплывающие уведомления и Автоматическое изменение высоты текстовых полей -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Обработка всплывающих уведомлений
            const toasts = document.querySelectorAll('.toast');
            toasts.forEach(toast => {
                if (toast) {
                    // Показать уведомление
                    toast.classList.add('show');

                    // Скрыть уведомление через 3 секунды
                    setTimeout(() => {
                        toast.classList.remove('show');
                    }, 3000);
                }
            });

            // Автоматическое изменение высоты текстовых полей
            const autoResize = (element) => {
                element.style.height = 'auto';
                element.style.height = (element.scrollHeight) + 'px';
            };

            const description = document.getElementById('description');
            const characteristics = document.getElementById('characteristics');

            // Инициализация высоты при загрузке страницы
            autoResize(description);
            autoResize(characteristics);

            // Добавление обработчиков событий
            description.addEventListener('input', () => autoResize(description));
            characteristics.addEventListener('input', () => autoResize(characteristics));

            // Обработка ввода в поле цены
            const priceInput = document.getElementById('price');
            priceInput.addEventListener('input', () => {
                // Разрешить только цифры, одну запятую или точку
                let value = priceInput.value;
                // Заменить точку на запятую
                value = value.replace('.', ',');
                // Удалить все кроме цифр и запятой
                value = value.replace(/[^0-9,]/g, '');
                // Разрешить только одну запятую
                const parts = value.split(',');
                if (parts.length > 2) {
                    value = parts[0] + ',' + parts.slice(1).join('');
                }
                priceInput.value = value;
            });

            // Перед отправкой формы заменить запятую на точку
            const form = document.getElementById('editProductForm');
            form.addEventListener('submit', (e) => {
                const priceField = document.getElementById('price');
                let priceValue = priceField.value.replace(',', '.');
                priceField.value = priceValue;
            });
        });
    </script>
</body>
</html>
